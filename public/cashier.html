<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cashier</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/cashier.css">
</head>
<body class="min-h-screen p-6">
  <div class="tab-nav">
    <button id="tabNew" class="tab-button active">New Orders <span id="newCount" class="badge">0</span></button>
    <button id="tabHist" class="tab-button">All Orders</button>
    <button id="tabLog" class="tab-button">Refund Log</button>
  </div>
  <!-- New -->
  <div id="newSec">
    <h1 class="text-2xl font-bold mb-4">New Orders</h1>
    <div id="orders" class="space-y-4"></div>
  </div>
  <!-- History -->
  <div id="histSec" style="display:none;">
    <input id="search" class="search-input" placeholder="Search order idâ€¦" />
    <div id="history" class="space-y-4"></div>
  </div>
  <!-- Refund Log -->
  <div id="logSec" style="display:none;">
    <h2 class="text-lg font-semibold mb-2">Recent Refunds</h2>
    <div class="table-container">
      <table class="w-full text-sm" id="logTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Fee</th>
            <th>Net</th>
            <th>Created</th>
            <th>Available</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const BASE = location.protocol==='file:' ? 'http://localhost:3000' : '';

  const fmt = (c)=>new Intl.NumberFormat('en-US',{style:'currency',currency:'usd'}).format(c/100);
  function fmtTime(ms){
    const m=Math.floor(ms/60000),s=Math.floor(ms/1000)%60;
    return m+':' + s.toString().padStart(2,'0');
  }
  async function load(){
    const orders = await fetch(`${BASE}/api/orders`).then(r=>r.json());
    const container=document.getElementById('orders');
    container.innerHTML='';
    const active=orders.filter(o=>o.state!=='hold');
      document.getElementById('newCount').textContent=active.length;
      active.forEach(o=>{
      const div=document.createElement('div');
      div.className='order-card';
      if(o.items.some(i=>i.name.toLowerCase().includes('ice cream'))) div.className+=' ice-cream';
      
      const items=o.items.map(i=>`<div class="order-item"><span class="item-name">${i.name}</span><span><span class="item-qty">${i.quantity}</span></span></div>`).join('');
      
      div.innerHTML=`
        <div class="order-header">
          <span class="order-id">Order #${o.id}</span>
          <span class="order-time">${new Date(o.created).toLocaleTimeString()}</span>
        </div>
        <div class="order-items">${items}</div>
        <div class="order-total">Total: ${fmt(o.amount)}</div>
        <div class="text-right mb-3">Est. time: ${fmtTime(o.estTime||0)}</div>
        <div class="text-right">
          <button class="done btn btn-primary" data-id="${o.id}">Mark as Done</button>
        </div>`;
      container.appendChild(div);
    });
    document.querySelectorAll('.done').forEach(b=>b.onclick=async()=>{
      await fetch(`${BASE}/api/orders/${b.dataset.id}/done`,{method:'POST'});
      load();
    });
  }
  load();
  setInterval(load,5000);

  async function loadHist(){
    const list=await fetch(`${BASE}/api/orders/history`).then(r=>r.json());
    const container=document.getElementById('history');
    container.innerHTML='';
    const term=document.getElementById('search').value.trim();
    list.filter(o=>!term||String(o.id).includes(term)).forEach(o=>{
      const div=document.createElement('div');
      div.className='order-card';
      const items=o.items.map(i=>`<div class="order-item"><span class="item-name">${i.name}</span><span><span class="item-qty">${i.quantity}</span></span></div>`).join('');
      div.innerHTML=`
        <div class="order-header">
          <span class="order-id">Order #${o.id}</span>
          <span class="order-time">${new Date(o.created).toLocaleString()}</span>
        </div>
        <div class="order-items">${items}</div>
        <div class="order-total">Total: ${fmt(o.amount)}</div>
        <div class="text-right mb-3">Status: ${o.state}</div>
        <div class="text-right">
          ${o.state!=='refunded'?`<button class="refund btn btn-danger" data-id="${o.id}">Full Refund</button>`:''}
        </div>
        <div class="mt-3 space-y-2">
          ${o.items.map(i=>`${i.quantity>0?`<div class="flex items-center justify-between"><span>${i.name} (${i.quantity})</span><button class="refund-line btn btn-outline text-amber-700" data-pid="${i.priceId}">Refund Item</button></div>`:''}`).join('')}
        </div>`;
      container.appendChild(div);
    });
    document.querySelectorAll('.refund').forEach(b=>b.onclick=async()=>{
      if(!confirm('Refund this order?')) return;
      await fetch(`${BASE}/api/orders/${b.dataset.id}/refund`,{method:'POST'});
      loadHist();
    });
    document.querySelectorAll('.refund-line').forEach(b=>b.onclick=()=>{
      const max=parseInt(b.dataset.qty);
      const sel=document.createElement('select');
      for(let i=1;i<=max;i++){const o=document.createElement('option');o.value=i;o.textContent=i;sel.appendChild(o);} 
      const ok=document.createElement('button');ok.textContent='OK';ok.className='ml-2 px-2 py-0.5 border';
      b.after(sel);sel.after(ok);b.disabled=true;
      ok.onclick=()=>{
        const n=parseInt(sel.value);
        fetch(`${BASE}/api/orders/${b.closest('div').querySelector('.refund').dataset.id}/refund-line`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({priceId:b.dataset.pid,qty:n})}).then(r=>{
          if(!r.ok){r.json().then(d=>alert(d.error||'Error'));}
          loadHist();
        });
      };
    });
  }
  document.getElementById('search').oninput=()=>loadHist();

  // tab logic
  const tabNew=document.getElementById('tabNew');const tabHist=document.getElementById('tabHist');const newSec=document.getElementById('newSec');const histSec=document.getElementById('histSec');
  const tabLog=document.getElementById('tabLog');const logSec=document.getElementById('logSec');
  tabNew.onclick=()=>{newSec.style.display='block';histSec.style.display='none';logSec.style.display='none';tabNew.classList.add('border-gray-800');tabHist.classList.remove('border-gray-800');tabLog.classList.remove('border-gray-800');};
  tabHist.onclick=()=>{histSec.style.display='block';newSec.style.display='none';logSec.style.display='none';tabHist.classList.add('border-gray-800');tabNew.classList.remove('border-gray-800');tabLog.classList.remove('border-gray-800');loadHist();};
  tabLog.onclick=()=>{logSec.style.display='block';newSec.style.display='none';histSec.style.display='none';tabLog.classList.add('border-gray-800');tabNew.classList.remove('border-gray-800');tabHist.classList.remove('border-gray-800');loadLog();};

  async function loadLog(){
    const rows=document.querySelector('#logTable tbody');rows.innerHTML='';
    const list=await fetch(`${BASE}/api/refund-log`).then(r=>r.json());
    list.forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.id}</td><td>${t.type}</td><td>${(t.amount/100).toFixed(2)}</td><td>${(t.fee/100).toFixed(2)}</td><td>${(t.net/100).toFixed(2)}</td><td>${new Date(t.created).toLocaleString()}</td><td>${new Date(t.available_on).toLocaleDateString()}</td><td>${t.description}</td>`;
      rows.appendChild(tr);
    });
  }
</script>
</body>
</html>
