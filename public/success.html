<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Success - Baklava House</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/success.css">
</head>
<body>
  <header>
    <span class="brand">Baklava House</span>
    <nav>
      <a href="/">Menu</a>
    </nav>
  </header>

  <div class="success-container animate-fade-in">
    <div class="success-icon">✓</div>
    <h1 class="success-title">Thank you for your order!</h1>
    <p id="msg" class="success-message">Your payment was successful.</p>
    
    <div class="order-details">
      <div id="order-id" class="order-id">Order #<span id="order-number"></span></div>
      <div id="order-email" class="order-email"></div>
    </div>
    
    <button id="hereBtn" class="btn hidden">I'm here</button>
    <a href="/" class="btn">Back to store</a>
  </div>

  <footer>
    <p>© 2025 Baklava House. All rights reserved.</p>
  </footer>

<script>
(async()=>{
  const urlParams=new URLSearchParams(location.search);
  const sessionId=urlParams.get('session_id');
  
  if(sessionId){
    // clear saved cart so next order starts fresh
    try{localStorage.removeItem('cart');}catch{}
    document.cookie='cart=;path=/;max-age=0';
    
    // Complete the session and get order details
    await fetch('/api/session-complete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId})});
    const order=await fetch('/api/order-status/'+sessionId).then(r=>r.json());
    
    // Display order information
    document.getElementById('order-number').textContent = order.id || '';
    if(order.email) {
      document.getElementById('order-email').textContent = order.email;
    } else {
      document.getElementById('order-email').style.display = 'none';
    }
    
    // Handle ice cream orders
    if(order.status==='icecream-hold'){
      document.getElementById('msg').textContent='Your ice cream will be prepared fresh. Press the button when you arrive.';
      const btn=document.getElementById('hereBtn');
      btn.classList.remove('hidden');
      btn.onclick=async()=>{
        btn.disabled=true;
        btn.textContent='Notifying...';
        await fetch('/api/orders/'+order.id+'/arrived',{method:'POST'});
        btn.textContent='Notified!';
        setTimeout(() => {
          document.getElementById('msg').textContent = "We're preparing your ice cream now!";
        }, 1000);
      };
    }
    
    // Helper to persist orders with cookie fallback
    function storeOrder(id){
      let arr=[];
      try{arr=JSON.parse(localStorage.getItem('orders')||'[]');}catch{}
      if(!Array.isArray(arr)) arr=[];
      if(!arr.includes(id)){
        arr.push(id);
        try{localStorage.setItem('orders',JSON.stringify(arr));}catch{} 
      }
      document.cookie='orders='+encodeURIComponent(JSON.stringify(arr))+';path=/;max-age=2592000';
    }
    
    storeOrder(sessionId);
  } else {
    // No session ID found
    document.getElementById('msg').textContent = 'No order information found. Please check your email for order details.';
    document.getElementById('order-id').style.display = 'none';
    document.getElementById('order-email').style.display = 'none';
  }
})();

</script></body></html>
